<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="./js/marked.min.js"></script>
    <script type="text/javascript" src="./js/request.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/theme.css">
    <link rel="stylesheet" type="text/css" href="./css/reader.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
    <title>阅读器</title>
</head>
<body>
    <nav>
        <div class="logo">MDShare</div>
        <div class="nav-tiem">
            <div>首页</div>
        </div>
    </nav>
    <main>
        <header>目录</header>
        <section>
            <div class="md_title"></div>
            <div class="md_info"></div>
            <div class="article print-element"></div>
        </section>
        <footer>
            评论区
        </footer>
    </main>
</body>
<script>
    onload = async ()=>{
        let filename = request.getUrlParams(decodeURI(location.href)).file;
        document.title = filename;
        document.querySelector(".md_title").innerHTML = filename;
        let result = await request.sync_post("getMd",{filename:filename+".md"});
        document.querySelector(".md_info").innerHTML = `创建日期:${FnewDate(result.metadata.ctime)} 阅读量:${result.metadata.look+1} 收藏量:${result.metadata.like} 修改时间:${FnewDate(result.metadata.mtime)}`;
        showMd(result.content);
    }
    showMd = function(mdtext){
        document.querySelector(".article").innerHTML=marked.parse(mdtext.replace('﻿',''));
        MathJax.typeset([".article"]);
        hljs.highlightAll();
        setTitleNum(".article");
    }
    FnewDate=function (time) {
        function padZero(num) {
            return (num < 10 ? '0' : '') + num;
        }
        if (time) {
            var date = new Date(time);
        } else {
            var date = new Date();
        }
        var year = date.getFullYear(),
            month = padZero(date.getMonth() + 1),
            day = padZero(date.getDate()),
            hour = padZero(date.getHours()),
            min = padZero(date.getMinutes()),
            sec = padZero(date.getSeconds());
        var newTime =
            year + '-' +
            month + '-' +
            day + ' ' +
            hour + ':' +
            min + ':' +
            sec;
        return newTime;
    }
    setTitleNum = function(emName){
        let emList = document.querySelector(emName).children;
        let Num = [];
        for(var i=0;i<emList.length;i++){
            let tagName = emList[i].tagName;
            if(tagName.length != 2 || tagName.slice(0,1) != "H"){
                continue;
            }
            let bit = tagName.slice(1,2);
            Num = Num.splice(0,bit);
            if(Num[bit-1]===undefined){
                Num[bit-1] = 1;
            }else{
                Num[bit-1]++;
            }
            let orderString = "";
            let pString = "";
            for(var j=0;j<Num.length;j++){
                orderString += orderString ? "."+Num[j] : Num[j];
                pString += pString? "_"+Num[j] : Num[j];
            }
            emList[i].innerHTML = orderString+"、"+emList[i].innerHTML;
            emList[i].setAttribute("id","p"+pString);
            console.log(orderString+"、");
        }
    }
    scrollTo = function(idName){
        document.querySelector(idName).scrollIntoView({behavior:"smooth"});
    }
</script>
</html>